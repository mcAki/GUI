<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>Google 地图 JavaScript API 示例: 简单的地图</title>
    <script src="http://ditu.google.cn/maps?file=api&amp;v=2&amp;key=ABQIAAAAzr2EBOXUKnm_jVnk0OJI7xSosDVG8KKPE1-m51RBrvYughuyMxQ-i1QfUnH94QxWIa6N4U6MouMmBA&hl=zh-CN"
            type="text/javascript"></script>
    <script type="text/javascript">
	var map = null;
	var gdir;
	var addressMarker;

	var geocoder = null;
	var marker = null;
	
	var my_X,my_Y;
    function initialize() {
      if (GBrowserIsCompatible()) {
        map = new GMap2(document.getElementById("map_canvas"));
        geocoder = new GClientGeocoder();
		//初始化路线生成
		gdir = new GDirections(map, document.getElementById("directions"));
        GEvent.addListener(gdir, "load", onGDirectionsLoad);
        GEvent.addListener(gdir, "error", handleErrors);


		//加入控件
		//小型缩放
		map.addControl(new GSmallZoomControl());
		//多个地图类型选择器的一组精选的嵌套按钮和菜单项
		map.addControl(new GHierarchicalMapTypeControl());
		//位于屏幕一角的可折叠概览地图
		map.addControl(new GOverviewMapControl());
		//地图比例尺 
		map.addControl(new GScaleControl());
		 
		//设置中心点
		map.setCenter(new GLatLng(23.12897,113.26683), 14);		
      
		var point = new GLatLng(23.12897,113.26683);
		//换图标		
		var baseIcon = new GIcon(G_DEFAULT_ICON); 
		baseIcon.shadow = "http://www.google.cn/mapfiles/shadow50.png"; 
		baseIcon.iconSize = new GSize(20, 34); 
		baseIcon.shadowSize = new GSize(37, 34); 
		baseIcon.iconAnchor = new GPoint(9, 34); 
		baseIcon.infoWindowAnchor = new GPoint(9, 2); 		
		
		//添加一个可拖拉的标记
		markerOptions = { icon:baseIcon, draggable:true, }; 		
		marker = new GMarker(point, markerOptions);
		GEvent.addListener(marker, "dragstart", 
			function() {
				map.closeInfoWindow();
			});  
		GEvent.addListener(marker, "dragend", 
			function() {
				//alert(marker);
				var mapAnchor = marker.getPoint();
				//alert(x);
				marker.openInfoWindowHtml("Anchor: x" + mapAnchor.x + " y:"+ mapAnchor.y);   
				my_X = mapAnchor.x;
				my_Y = mapAnchor.y;
			});  
		map.addOverlay(marker);

	    //添加一个不可拉的标记
		var point2 = new GLatLng(23.12997,113.26983);
		map.addOverlay(new GMarker(point2));
		
	
	  }   
 
	  
	  
	  
	  showMessage();
    }
	
	//按真实地址查找经纬度
	function showAddress(address) {
      if (geocoder) {
        geocoder.getLatLng(
          address,
          function(point) {
            if (!point) {
              alert("对不起，您的默认地址不能解析: " + address + char(13) + char(10) + "请手工定位!");
            } else {
              map.setCenter(point, 13);
              var marker = new GMarker(point);
              map.addOverlay(marker);
              marker.openInfoWindowHtml(address);
            }
          }
        );
      }
    }

	//设置地图类型
	function setMapType(ConstType){
		//普通:G_NORMAL_MAP
		//卫星:G_SATELLITE_MAP
        //结合:G_HYBRID_MAP
		map.setMapType(ConstType);
	}
	
	//显示漫画式消息
	function showMessage(){
		map.openInfoWindow(new GLatLng(23.12897,113.26683), document.createTextNode("志愿时系统专用"));
	}
	
	//路径生成！
    function setDirections(fromAddress, toAddress, locale) {
      gdir.load("from: " + fromAddress + " to: " + toAddress,
                { "locale": locale });
    }

	
	//路径生成器错误拦截
	function handleErrors(){
	   if (gdir.getStatus().code == G_GEO_UNKNOWN_ADDRESS)
	     alert("No corresponding geographic location could be found for one of the specified addresses. This may be due to the fact that the address is relatively new, or it may be incorrect.\nError code: " + gdir.getStatus().code);
	   else if (gdir.getStatus().code == G_GEO_SERVER_ERROR)
	     alert("A geocoding or directions request could not be successfully processed, yet the exact reason for the failure is not known.\n Error code: " + gdir.getStatus().code);
	   
	   else if (gdir.getStatus().code == G_GEO_MISSING_QUERY)
	     alert("The HTTP q parameter was either missing or had no value. For geocoder requests, this means that an empty address was specified as input. For directions requests, this means that no query was specified in the input.\n Error code: " + gdir.getStatus().code);
 
	//   else if (gdir.getStatus().code == G_UNAVAILABLE_ADDRESS)  <--- Doc bug... this is either not defined, or Doc is wrong
	//     alert("The geocode for the given address or the route for the given directions query cannot be returned due to legal or contractual reasons.\n Error code: " + gdir.getStatus().code);
	     
	   else if (gdir.getStatus().code == G_GEO_BAD_KEY)
	     alert("The given key is either invalid or does not match the domain for which it was given. \n Error code: " + gdir.getStatus().code);
 
	   else if (gdir.getStatus().code == G_GEO_BAD_REQUEST)
	     alert("A directions request could not be successfully parsed.\n Error code: " + gdir.getStatus().code);
	    
	   else alert("An unknown error occurred.");
	   
	}
 	//路径生成器预读事件
	function onGDirectionsLoad(){ 
      // Use this function to access information about the latest load()
      // results.
 
      // e.g.
      // document.getElementById("getStatus").innerHTML = gdir.getStatus().code;
	  // and yada yada yada...
	}

	
    </script>
  </head>
  <body onload="initialize()" onunload="GUnload()">
  <form action="#" id="form1" >
  <p>
        <input type="text" size="60" name="address" value="广州市荔湾区市少年宫" />
        <input type="button" value="Go!" onclick="showAddress(form1.address.value);" />
  </p>
  <p>从<input type="text" size="25" id="fromAddress" name="from" value="广州市荔湾区东风西路"/> 至 
     <input type="text" size="25" id="toAddress" name="to" value="广州市天河体育中心" />
     <input type="button" value="两点寻求路径" onclick="setDirections(form1.fromAddress.value, form1.toAddress.value, 'cn'); " />
     <input type="button" value="出发自定义路径" onclick="setDirections(my_Y + ',' + my_X, form1.toAddress.value, 'cn'); " />

  </p>
  <input type="button" value="普通" onclick="setMapType(G_NORMAL_MAP);"/>
  <input type="button" value="卫星" onclick="setMapType(G_SATELLITE_MAP);" />
  <input type="button" value="结合" onclick="setMapType(G_HYBRID_MAP);" />
  </form>
    <div id="map_canvas" style="width: 500px; height: 500px"></div>
    <div id="directions" style="width: 275px"></div>
  </body>
</html>
